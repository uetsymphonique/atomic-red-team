{
  "attack_technique": "T1547.006",
  "display_name": "Boot or Logon Autostart Execution: Kernel Modules and Extensions",
  "atomic_tests": [
    {
      "name": "Linux - Load Kernel Module via insmod",
      "description": "This test uses the insmod command to load a kernel module for Linux.",
      "supported_platforms": [
        "linux"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": true,
        "cleanup_command": "sudo rmmod #{module_name}\n[ -f #{temp_folder}/safe_to_delete ] && rm -rf #{temp_folder}",
        "procedure": "sudo insmod #{module_path}"
      },
      "input_arguments": [
        {
          "arg_name": "module_name",
          "description": "Name of the kernel module name.",
          "type": "string",
          "default": "T1547006"
        },
        {
          "arg_name": "module_path",
          "description": "Folder used to store the module.",
          "type": "path",
          "default": "/tmp/T1547.006/T1547006.ko"
        },
        {
          "arg_name": "temp_folder",
          "description": "Temp folder used to compile the code.",
          "type": "path",
          "default": "/tmp/T1547.006"
        },
        {
          "arg_name": "module_source_path",
          "description": "Path to download Gsecdump binary file",
          "type": "path",
          "default": "PathToAtomicsFolder/T1547.006/src"
        }
      ],
      "dependencies": [
        {
          "description": "The kernel module must exist on disk at specified location",
          "prereq_command": "if [ -f #{module_path} ]; then exit 0; else exit 1; fi;",
          "get_prereq_command": "if [ ! -d #{temp_folder} ]; then mkdir #{temp_folder}; touch #{temp_folder}/safe_to_delete; fi;\ncp #{module_source_path}/* #{temp_folder}/\ncd #{temp_folder}; make\nif [ ! -f #{module_path} ]; then mv #{temp_folder}/#{module_name}.ko #{module_path}; fi;"
        }
      ],
      "auto_generated_guid": "687dcb93-9656-4853-9c36-9977315e9d23"
    },
    {
      "name": "MacOS - Load Kernel Module via kextload and kmutil",
      "description": "This test uses the kextload and kmutil commands to load and unload a MacOS kernel module.",
      "supported_platforms": [
        "macos"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": true,
        "procedure": "set -x\nsudo kextload #{module_path}\nkextstat 2>/dev/null | grep SoftRAID\nsudo kextunload #{module_path}\nsudo kmutil load -p #{module_path}\nkextstat 2>/dev/null | grep SoftRAID\nsudo kmutil unload -p #{module_path}"
      },
      "input_arguments": [
        {
          "arg_name": "module_path",
          "description": "Folder used to store the module.",
          "type": "path",
          "default": "/Library/Extensions/SoftRAID.kext"
        }
      ],
      "dependencies": [
        {
          "description": "The kernel module must exist on disk at specified location",
          "prereq_command": "if [ -d #{module_path} ] ; then exit 0; else exit 1 ; fi",
          "get_prereq_command": "exit 1"
        }
      ],
      "auto_generated_guid": "f4391089-d3a5-4dd1-ab22-0419527f2672"
    },
    {
      "name": "MacOS - Load Kernel Module via KextManagerLoadKextWithURL()",
      "description": "This test uses the IOKit API to load a kernel module for macOS.\nHarcoded to use SoftRAID kext",
      "supported_platforms": [
        "macos"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": true,
        "cleanup_command": "rm -f #{exe_path}",
        "procedure": "sudo #{exe_path}\nkextstat 2>/dev/null | grep SoftRAID\nsudo kextunload /Library/Extensions/SoftRAID.kext"
      },
      "input_arguments": [
        {
          "arg_name": "src_path",
          "description": "Folder used to store the module.",
          "type": "path",
          "default": "PathToAtomicsFolder/T1547.006/src/macos_kextload.c"
        },
        {
          "arg_name": "exe_path",
          "description": "Folder used to store the module.",
          "type": "path",
          "default": "/tmp/T1547006_iokit_loader"
        }
      ],
      "dependencies": [
        {
          "description": "The kernel module must exist on disk at specified location",
          "prereq_command": "if [ -f \"#{exe_path}\" ]; then exit 0 ; else exit 1; fi",
          "get_prereq_command": "cc -o #{exe_path} #{src_path} -framework IOKit -framework Foundation"
        }
      ],
      "auto_generated_guid": "f0007753-beb3-41ea-9948-760785e4c1e5"
    },
    {
      "name": "Snake Malware Kernel Driver Comadmin",
      "description": "The following Atomic Test will write an file, comadmin.dat, to disk. From the report, Snake's installer drops the kernel driver and a custom DLL which is used to load the driver into a\nsingle AES encrypted file on disk. Typically, this file is named “comadmin.dat” and is stored in the %windows%\\system32\\Com directory. \nThis Atomic Test will write a hardcoded named file to disk in the com directory named comadmin.dat.\n[Snake Malware - CISA](https://media.defense.gov/2023/May/09/2003218554/-1/-1/0/JOINT_CSA_HUNTING_RU_INTEL_SNAKE_MALWARE_20230509.PDF)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "$examplePath = Join-Path $env:windir \"system32\\Com\"; $exampleName = \"comadmin.dat\"; $exampleFullPath = Join-Path $examplePath $exampleName; if (Test-Path $exampleFullPath) { Remove-Item $exampleFullPath -Force }",
        "procedure": "$examplePath = Join-Path $env:windir \"system32\\Com\"; if (-not (Test-Path $examplePath)) { New-Item -ItemType Directory -Path $examplePath | Out-Null }; $exampleName = \"comadmin.dat\"; $exampleFullPath = Join-Path $examplePath $exampleName; $randomBytes = New-Object Byte[] 0x1000; (New-Object Random).NextBytes($randomBytes); [System.IO.File]::WriteAllBytes($exampleFullPath, $randomBytes)"
      },
      "input_arguments": [],
      "auto_generated_guid": "e5cb5564-cc7b-4050-86e8-f2d9eec1941f"
    }
  ]
}