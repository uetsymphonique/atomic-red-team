{
  "attack_technique": "T1021.001",
  "display_name": "Remote Services: Remote Desktop Protocol",
  "atomic_tests": [
    {
      "name": "RDP to DomainController",
      "description": "Attempt an RDP session via Remote Desktop Application to a DomainController.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "$p=Tasklist /svc /fi \"IMAGENAME eq mstsc.exe\" /fo csv | convertfrom-csv\nif(-not ([string]::IsNullOrEmpty($p.PID))) { Stop-Process -Id $p.PID }",
        "procedure": "$Server=#{logonserver}\n$User = Join-Path #{domain} #{username}\n$Password=\"#{password}\"\ncmdkey /generic:TERMSRV/$Server /user:$User /pass:$Password\nmstsc /v:$Server\necho \"RDP connection established\""
      },
      "input_arguments": [
        {
          "arg_name": "logonserver",
          "description": "ComputerName argument default %logonserver%",
          "type": "string",
          "default": "$ENV:logonserver.TrimStart(\"\\\")"
        },
        {
          "arg_name": "domain",
          "description": "domain argument default %USERDOMAIN%",
          "type": "string",
          "default": "$Env:USERDOMAIN"
        },
        {
          "arg_name": "username",
          "description": "Username argument default %username%",
          "type": "string",
          "default": "$ENV:USERNAME"
        },
        {
          "arg_name": "password",
          "description": "Password",
          "type": "string",
          "default": "1password2!"
        }
      ],
      "dependencies": [
        {
          "description": "Computer must be domain joined",
          "prereq_command": "if((Get-CIMInstance -Class Win32_ComputerSystem).PartOfDomain) { exit 0} else { exit 1}",
          "get_prereq_command": "Write-Host Joining this computer to a domain must be done manually"
        }
      ],
      "auto_generated_guid": "355d4632-8cb9-449d-91ce-b566d0253d3e"
    },
    {
      "name": "Changing RDP Port to Non Standard Port via Powershell",
      "description": "Changing RDP Port to Non Standard Port via Powershell",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp' -name \"PortNumber\" -Value #{OLD_Remote_Port}\nRemove-NetFirewallRule -DisplayName \"RDPPORTLatest-TCP-In\" -ErrorAction Ignore \nGet-Service TermService | Restart-Service -Force -ErrorAction Ignore",
        "procedure": "Set-ItemProperty -Path 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp' -name \"PortNumber\" -Value #{NEW_Remote_Port}\nNew-NetFirewallRule -DisplayName 'RDPPORTLatest-TCP-In' -Profile 'Public' -Direction Inbound -Action Allow -Protocol TCP -LocalPort #{NEW_Remote_Port}"
      },
      "input_arguments": [
        {
          "arg_name": "OLD_Remote_Port",
          "description": "Default RDP Listening Port",
          "type": "string",
          "default": "3389"
        },
        {
          "arg_name": "NEW_Remote_Port",
          "description": "New RDP Listening Port",
          "type": "string",
          "default": "4489"
        }
      ],
      "auto_generated_guid": "2f840dd4-8a2e-4f44-beb3-6b2399ea3771"
    },
    {
      "name": "Changing RDP Port to Non Standard Port via Command_Prompt",
      "description": "Changing RDP Port to Non Standard Port via Command_Prompt",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg add \"HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" /v PortNumber /t REG_DWORD /d #{OLD_Remote_Port} /f >nul 2>&1\nnetsh advfirewall firewall delete rule name=\"RDPPORTLatest-TCP-In\" >nul 2>&1\nnet stop TermService /y >nul 2>&1\nnet start TermService >nul 2>&1",
        "procedure": "reg add \"HKLM\\System\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" /v PortNumber /t REG_DWORD /d #{NEW_Remote_Port} /f\nnetsh advfirewall firewall add rule name=\"RDPPORTLatest-TCP-In\" dir=in action=allow protocol=TCP localport=#{NEW_Remote_Port}"
      },
      "input_arguments": [
        {
          "arg_name": "OLD_Remote_Port",
          "description": "Default RDP Listening Port",
          "type": "string",
          "default": "3389"
        },
        {
          "arg_name": "NEW_Remote_Port",
          "description": "New RDP Listening Port",
          "type": "string",
          "default": "4489"
        }
      ],
      "auto_generated_guid": "74ace21e-a31c-4f7d-b540-53e4eb6d1f73"
    },
    {
      "name": "Disable NLA for RDP via Command Prompt",
      "description": "Disables network-level authentication (NLA) for RDP by changing a registry key via Command Prompt\nDisabling NLA for RDP can allow remote user interaction with the Windows sign-in screen prior to authentication. According to Microsoft, Flax Typhoon actors used this technique implementation to achieve persistence on victim systems: https://www.microsoft.com/en-us/security/blog/2023/08/24/flax-typhoon-using-legitimate-software-to-quietly-access-taiwanese-organizations/\nSee also: https://github.com/EmpireProject/Empire/blob/master/lib/modules/powershell/management/enable_rdp.py",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": false,
        "cleanup_command": "reg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" /v UserAuthentication /d #{Default_UserAuthentication} /t REG_DWORD -f >nul 2>&1",
        "procedure": "reg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\" /v UserAuthentication /d 0 /t REG_DWORD /f"
      },
      "input_arguments": [
        {
          "arg_name": "Default_UserAuthentication",
          "description": "Default UserAuthentication registry value",
          "type": "string",
          "default": "1"
        }
      ],
      "auto_generated_guid": "01d1c6c0-faf0-408e-b368-752a02285cb2"
    }
  ]
}