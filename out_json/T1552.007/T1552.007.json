{
  "attack_technique": "T1552.007",
  "display_name": "Kubernetes List Secrets",
  "atomic_tests": [
    {
      "name": "List All Secrets",
      "description": "A Kubernetes secret is an object that lets users store and manage sensitive information, such as passwords and connection strings in the cluster. Secrets can be consumed by reference in the pod configuration. Attackers who have permissions to retrieve the secrets from the API server (by using the pod service account, for example) can access sensitive information that might include credentials to various services or provide further access to the cluster.\n[More information about secrets](https://kubernetes.io/docs/concepts/configuration/secret/).\n\nThis test will make a request to the Kubernetes api at the `/api/v1/secrets` endpoint requesting every secret stored within the cluster.",
      "supported_platforms": [
        "containers"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": false,
        "command": "kubectl get secrets --all-namespaces"
      },
      "input_arguments": {},
      "dependencies": [
        {
          "description": "kubectl must be installed",
          "prereq_command": "which kubectl",
          "get_prereq_command": "echo \"kubectl not installed, please install kubectl (https://kubernetes.io/docs/tasks/tools/)\""
        }
      ],
      "auto_generated_guid": "31e794c4-48fd-4a76-aca4-6587c155bc11"
    },
    {
      "name": "ListSecrets",
      "description": "A Kubernetes secret is an object that lets users store and manage sensitive information, such as passwords and connection strings in the cluster. Secrets can be consumed by reference in the pod configuration. Attackers who have permissions to retrieve the secrets from the API server (by using the pod service account, for example) can access sensitive information that might include credentials to various services.",
      "supported_platforms": [
        "containers"
      ],
      "executor": {
        "name": "bash",
        "elevation_required": false,
        "command": "kubectl get secrets -n #{namespace}"
      },
      "input_arguments": {
        "namespace": {
          "description": "K8s namespace to list",
          "type": "string",
          "default": "default"
        }
      },
      "dependencies": [
        {
          "description": "kubectl must be installed",
          "prereq_command": "which kubectl",
          "get_prereq_command": "echo \"kubectl must be installed manually\""
        }
      ],
      "auto_generated_guid": "43c3a49d-d15c-45e6-b303-f6e177e44a9a"
    },
    {
      "name": "Cat the contents of a Kubernetes service account token file",
      "description": "Access the Kubernetes service account access token stored within a container in a cluster.",
      "supported_platforms": [
        "linux"
      ],
      "executor": {
        "name": "sh",
        "elevation_required": false,
        "command": "kubectl --context kind-atomic-cluster exec atomic-pod -- cat /run/secrets/kubernetes.io/serviceaccount/token",
        "cleanup_command": "kubectl --context kind-atomic-cluster delete pod atomic-pod"
      },
      "input_arguments": {},
      "dependencies": [
        {
          "description": "Verify docker is installed.",
          "prereq_command": "which docker",
          "get_prereq_command": "if [ \"\" == \"`which docker`\" ]; then echo \"Docker Not Found\"; if [ -n \"`which apt-get`\" ]; then sudo apt-get -y install docker ; elif [ -n \"`which yum`\" ]; then sudo yum -y install docker ; fi ; else echo \"Docker installed\"; fi"
        },
        {
          "description": "Verify docker service is running.",
          "prereq_command": "sudo systemctl status docker",
          "get_prereq_command": "sudo systemctl start docker"
        },
        {
          "description": "Verify kind is in the path.",
          "prereq_command": "which kind",
          "get_prereq_command": "curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64\nchmod +x ./kind\nmv kind /usr/bin/kind"
        },
        {
          "description": "Verify kind-atomic-cluster is created",
          "prereq_command": "sudo kind get clusters",
          "get_prereq_command": "sudo kind create cluster --name atomic-cluster"
        },
        {
          "description": "Verify kubectl is in path",
          "prereq_command": "which kubectl",
          "get_prereq_command": "curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\nchmod +x ./kubectl\nmv kubectl /usr/bin/kubectl"
        },
        {
          "description": "Verify atomic-pod is running.",
          "prereq_command": "kubectl --context kind-atomic-cluster get pods |grep atomic-pod",
          "get_prereq_command": "kubectl --context kind-atomic-cluster run atomic-pod --image=alpine --command -- sleep infinity"
        }
      ],
      "auto_generated_guid": "788e0019-a483-45da-bcfe-96353d46820f"
    }
  ]
}